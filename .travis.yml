sudo: required
conditions: v1
if: type = pull_request OR branch = master OR tag IS present
os: linux
git:
  depth: false
language: go
go: 1.13.x
go_import_path: go.thethings.network/lorawan-stack
env:
  global:
  - GOPROXY=https://proxy.golang.org
  - NODE_ENV=production
  - YARN_CACHE_FOLDER=$HOME/.cache/yarn
  - MAGE=$HOME/.cache/mage/mage
  - TEST_SLOWDOWN=8
  - TEST_REDIS=1
  - PATH=/snap/bin:$PATH
  - HUGO_BASE_URL=https://thethingsstack.io/
  - DOCKER_IMAGE=rvolosatovs/lorawan-stack
  - DOCKER_IMAGE_DEV=rvolosatovs/lorawan-stack-dev
matrix:
  include:
  - env: RUNTYPE=release
    if: tag IS present OR (type != pull_request AND branch = master)
services:
- docker
cache:
  directories:
  - "$GOPATH/pkg/mod"
  - "$HOME/.cache/go-build"
  - "$HOME/.cache/mage"
  - "$HOME/.cache/yarn"
before_install:
- |
  if [[ "$TRAVIS_EVENT_TYPE" == "push" ]] && [[ "$TRAVIS_BRANCH" == "master" ]]; then
    set -e
    go clean -modcache
    go clean -cache
    rm -rf $HOME/.cache/mage/*
    rm -rf $HOME/.cache/yarn/*
  fi
- |
  if [[ "$RUNTYPE" == "release" ]]; then
    nvm install 10.16.0
  fi
install:
- make init
- |
  if [[ "$RUNTYPE" == "release" ]]; then
    set -e
    $MAGE jsSDK:deps js:deps
    $MAGE docs:deps
  fi
script:
- if [[ "$RUNTYPE" == "release" ]]; then $MAGE version:files; fi
- |
  if [[ "$RUNTYPE" == "release" ]]; then
    set -e
    rm -rf doc/public
    mkdir doc/public
    git fetch
    git --work-tree=doc/public checkout origin/gh-pages -- .
    git reset -- .
    $MAGE docs:build
  fi
after_success:
- |
  if [[ "$RUNTYPE" == "release" ]]; then
    set -e
    $MAGE js:build
    docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
    if [[ ! -z "$TRAVIS_TAG" ]]; then
      GO111MODULE=on go run github.com/goreleaser/goreleaser
    else
      GO111MODULE=on go run github.com/goreleaser/goreleaser --snapshot
      if [[ ! -z "$DOCKER_IMAGE_DEV" ]]; then
        docker tag $DOCKER_IMAGE:latest $DOCKER_IMAGE_DEV:$TRAVIS_COMMIT
        docker push $DOCKER_IMAGE_DEV:$TRAVIS_COMMIT
      fi
    fi
  fi
deploy:
- provider: pages
  local_dir: doc/public
  skip_cleanup: true
  github_token: $GITHUB_TOKEN
  keep_history: true
  fqdn: thethingsstack.io
  on:
    tags: true
    condition: $RUNTYPE = "release"
